<div id="overview_failures" data-loaded='true'>
  <%= render 'issues/statistics', jobs_sql: @jobs_sql %>

  <% all_issues = Issue.where("issues.job_id IN (#{@jobs_sql})").count %>
  <% tool_failures = Issue.where("issues.part_id IS NOT NULL").where("issues.job_id IN (#{@jobs_sql})").count %>
  <% human_failures = Issue.where("issues.responsible_by_id IS NOT NULL").where("issues.job_id IN (#{@jobs_sql})").count %>

  <br><br><br>

  <div>
    <div class="chart-block tooltip-info align-top"
         data-title="Open Incidents">
      <div class="chart-title">Open Incidents</div>
      <div class="donut-chart-div job-donut-chart-div">
        <div class="donut-text chart-text-red"><%= Issue.where(:status => Issue::OPEN).where("issues.job_id IN (#{@jobs_sql})").count %></div>
        <div class="percentage chart-text-red">incidents</div>
      </div>
    </div>

    <div class="chart-block tooltip-info align-top"
         data-title="Open issues">
      <div class="chart-title">All Incidents</div>
      <div class="donut-chart-div job-donut-chart-div">
        <div class="donut-text"><%= all_issues %></div>
        <div class="percentage">incidents</div>
      </div>
    </div>


    <div class="chart-block tooltip-info"
         data-title="Total failures caused by tool failure">
      <div class="chart-title">Tool Failures</div>
      <div class="donut-chart-div">
        <div id="tool_failures_chart" class="donut-chart "></div>
        <div class="donut-inner-circle"></div>
        <div class="donut-text"><%= all_issues.length > 0 ? (tool_failures.to_f / all_issues.to_f * 100.0).round(0) : 0.0 %></div>
        <div class="percentage-circle">%</div>
      </div>
    </div>

    <div class="chart-block tooltip-info"
         data-title="Total failures caused by tool failure">
      <div class="chart-title">Human Failures</div>
      <div class="donut-chart-div">
        <div id="human_failures_chart" class="donut-chart "></div>
        <div class="donut-inner-circle"></div>
        <div class="donut-text"><%= all_issues.length > 0 ? (human_failures.to_f / all_issues.to_f * 100.0).round(0) : 0.0 %></div>
        <div class="percentage-circle">%</div>
      </div>
    </div>

  </div>

  <%= link_to "View all/open issues", issues_path, class: "btn btn-info white-text" %>

</div>

<script>

    var plot3 = $.jqplot('tool_failures_chart', [
        [
            ['a', <%= tool_failures %>],
            ['b', <%= all_issues - tool_failures %>]
        ]
    ], {
        animate: true,
        animateReplot: true,
        background: "#FFFFFF",
        seriesColors: [ "#458fd2", "#FFFFFF"],
        seriesDefaults: {
            textColor: " #00ff0000",
            shadow: false,
            renderer: $.jqplot.DonutRenderer,
            rendererOptions: {
                animation: {
                    show: true,
                    speed: 2500
                },
                padding: 0,
                innerDiameter: 95,
                sliceMargin: 0,
                startAngle: -90,
                showDataLabels: true,
                dataLabels: 'value'
            }
        }
    });

    plot3 = $.jqplot('human_failures_chart', [
        [
            ['a', <%= human_failures %>],
            ['b', <%= all_issues - human_failures %>]
        ]
    ], {
        animate: true,
        background: "#FFFFFF",
        seriesColors: [ "#458fd2", "#FFFFFF"],
        seriesDefaults: {
            textColor: " #00ff0000",
            shadow: false,
            renderer: $.jqplot.DonutRenderer,
            rendererOptions: {
                padding: 0,
                innerDiameter: 95,
                sliceMargin: 0,
                startAngle: -90,
                showDataLabels: true,
                dataLabels: 'value'
            }
        }
    });

</script>