<% provide(:title, @drilling_log.document.name) %>

<% if true %>
    <div class="page_header page-header-no-line">
      <h1 id="part_name">Drilling</h1>

      <div class="push-right btn-group inline pull-right push-down">
        <a class="custom-data-toggle-jobs" data-toggle="dropdown" href="#">
          Export
        </a>
        <ul class="dropdown-menu">
          <li>
            <%= link_to "Export as Excel", document_path(@drilling_log.document, format: "xlsx"),
                        target: "_blank",
                        class: "dropdown-menu-link tooltip-info submit-form",
                        "data-placement" => "left",
                        "data-title" => "Export log as Microsoft Excel file." %>
          </li>
        </ul>
      </div>

      <div class='pull-right'>
        <%= render 'jobs/job_multi_link', job: @drilling_log.job %>
      </div>
    </div>

<% else %>
    <%= render 'jobs/job_data_header', job: @drilling_log.job %>
    <br>
<% end %>

<div class='center'>
  <div class="inline-block" style="width:10px;height:10px;background:#00BBCC;"></div> <b>Drilling</b>
  <div class="inline-block push-right-small" style="width:10px;height:10px;background:#223bf2;"></div> <b>Sliding</b>
  <div class="inline-block push-right-small" style="width:10px;height:10px;background:#f24922;"></div> <b>NPT</b>
  <div class="inline-block push-right-small" style="width:10px;height:10px;background:#f24922;border-radius:100px;"></div> <b>POOH</b>

  <div class="inline-block push-right-small" style="width:10px;height:10px;background:#ccf7ff;"></div> <b>Time (hrs)</b>

</div>
<div id="ropchart" style="width: 100%; height: 400px;"></div>


<ul class="nav nav-pills alert alert-nav">
  <li class="active">
    <a href="#" class="job-tray-toggle custom-data-toggle" data-id="<%= @drilling_log.id %>"
       data-tray="drilling-overview">Overview</a>
  </li>

  <li class="">
    <a href="#" class="job-tray-toggle custom-data-toggle" data-id="<%= @drilling_log.id %>"
       data-tray="drilling-runs">Runs</a>
  </li>

  <li class="">
    <a href="#" class="job-tray-toggle custom-data-toggle" data-id="<%= @drilling_log.id %>"
       data-tray="drilling-daily">Days</a>
  </li>

  <li class="">
    <a href="#" class="job-tray-toggle custom-data-toggle" data-id="<%= @drilling_log.id %>"
       data-tray="drilling-bha">BHAs</a>
  </li>

  <li class="">
    <a href="#" class="job-tray-toggle custom-data-toggle" data-id="<%= @drilling_log.id %>"
       data-tray="npt">Non-Productive Time</a>
  </li>

  <li class="">
    <a href="#" class="job-tray-toggle custom-data-toggle"
       data-tray="log">Drilling Log</a>
  </li>
</ul>


<%= render 'drilling_logs/tray_log' %>

<div id="drilling_overview" class="" data-tray="drilling-overview">
  <div class="drilling-overview-loading">
    <%= render 'layouts/inline_loading', title: "Please wait, loading overview..." %>
  </div>
</div>

<div id="drilling_runs" class="job-tray custom-data-closed" data-tray="drilling-runs">
  <div class="drilling-runs-loading">
    <%= render 'layouts/inline_loading', title: "Please wait, loading runs..." %>
  </div>
</div>

<div id="drilling_daily" class="job-tray custom-data-closed" data-tray="drilling-daily">
  <div class="drilling-daily-loading">
    <%= render 'layouts/inline_loading', title: "Please wait, loading daily totals..." %>
  </div>
</div>

<div id="drilling_bha" class="job-tray custom-data-closed" data-tray="drilling-bha">
  <div class="drilling-bha-loading">
    <%= render 'layouts/inline_loading', title: "Please wait, loading BHA totals..." %>
  </div>
</div>

<div class="job-tray custom-data-closed" data-tray="npt">
</div>


<div id="modal_popup" class="modal-popup-background">
  <div class="modal-popup modal-popup-fixed">
    <%= link_to "close", "#", class: "delete-button modal-popup-close", id: "close_modal" %>
    <div class="modal-content">
    </div>
    <%= render "layouts/inline_loading", title: "Loading..." %>
  </div>
</div>

<script type='text/javascript'>
  if(document.location.hash == '') {
    $('#drilling_overview').find('.content').hide();
    $('.drilling-overview-loading').removeClass('hidden');
    $('.drilling-overview-loading').find('.loading').removeClass('hidden');
      setTimeout(function() {
    $.ajax({
        url: "/drilling_logs/<%= @drilling_log.id %>?section=drilling_overview",
        type: "GET",
        dataType: "script"
    });
      }, 1);
  }
</script>


<script type='text/javascript'>

  <% if true %>

  <% drilling_log = @drilling_log %>
    <% if drilling_log.drilling_log_entries.any? %>
    <% rops = [] %>
    <% last_entry = drilling_log.drilling_log_entries.first %>
    <% drilling_log.drilling_log_entries.each do |dl| %>
        <% time = (dl.entry_at - last_entry.entry_at).to_f / 60.0 / 60.0 %>
        <% if dl.activity_code == DrillingLogEntry::DRILLING || dl.activity_code == DrillingLogEntry::SLIDING || time > 0.1 %>
        <% rops <<  { "date" => dl.entry_at.strftime("%m/%d/%Y %k:%M"), "time" => time > 0  ? time.round(2) : 0.0, "activity" => DrillingLogEntry.activity_code_string(dl.activity_code), "rop" => dl == last_entry || dl.activity_code == DrillingLogEntry::TIH || dl.activity_code == DrillingLogEntry::POOH ? 0.0 : ((dl.depth - last_entry.depth).to_f / (dl.entry_at - last_entry.entry_at).to_f * 60.0).round(2), "lineColor" => dl.activity_code == DrillingLogEntry::DRILLING || dl.activity_code == DrillingLogEntry::SLIDING ? (dl.activity_code == DrillingLogEntry::DRILLING ? "#00BBCC" : "#223bf2") : "#f24922", "bulletSize" => (dl.activity_code == DrillingLogEntry::POOH && last_entry.activity_code != DrillingLogEntry::POOH)  ? 11 : 0, "bulletColor" => dl.activity_code == DrillingLogEntry::CHANGE_BHA  ? "#000000" : "#f24922" } %>
        <% end %>
        <% last_entry = dl %>
  <% end %>

    var average = <%= drilling_log.nil? || drilling_log.rop.nil? ? 0.0 : drilling_log.rop.round(1) %>;

    // SERIAL CHART
    var chart = new AmCharts.AmSerialChart();
    chart.pathToImages = "http://www.amcharts.com/lib/3/images/";
    chart.dataProvider = <%= raw rops.to_json.html_safe %>;
    chart.categoryField = "date";
    chart.dataDateFormat = "MM/DD/YYYY H:NN";

    // AXES
    // category

    var categoryAxis = chart.categoryAxis;
    categoryAxis.parseDates = false;
    categoryAxis.minPeriod = "mm"; // our data is daily, so we set minPeriod to DD
    categoryAxis.dashLength = 1;
    categoryAxis.gridAlpha = 0.15;
    categoryAxis.axisColor = "#DADADA";
    categoryAxis.labelFunction =   function (value, valueString, axis){
        return '';
    };

    // value
    var valueAxis = new AmCharts.ValueAxis();
    valueAxis.axisColor = "#DADADA";
  valueAxis.title = "ROP";
  valueAxis.dashLength = 1;
  valueAxis.position = "left";
    //valueAxis.logarithmic = true; // this line makes axis logarithmic
    chart.addValueAxis(valueAxis);

  var timeAxis = new AmCharts.ValueAxis();
  timeAxis.title = "Time";
  timeAxis.gridAlpha = 0;
  timeAxis.axisAlpha = 0;
  timeAxis.position = "right";
  chart.addValueAxis(timeAxis);

    // GUIDE for average
    var guide = new AmCharts.Guide();
    guide.value = average;
    guide.lineColor = "#CC0000";
    guide.dashLength = 4;
    guide.label = "average";
    guide.inside = true;
    guide.lineAlpha = 1;
    valueAxis.addGuide(guide);


  var timeGraph = new AmCharts.AmGraph();
  timeGraph.valueField = "time";
  timeGraph.title = "Time (Hours)";
  timeGraph.type = "column";
  timeGraph.fillAlphas = 1;
  timeGraph.valueAxis = timeAxis;
  timeGraph.balloonText = "Time [[time]] hrs";
  timeGraph.lineColor = "#ccf7ff";
  timeGraph.lineThickness = 0;
  timeGraph.dashLengthField = "dashLength";
  timeGraph.alphaField = "alpha";
  chart.addGraph(timeGraph);

    // GRAPH
    var graph = new AmCharts.AmGraph();
    graph.type = "step";
    graph.bullet = "round";
    graph.bulletColorField = "bulletColor";
    graph.bulletBorderColor = "bulletColor";
    graph.bulletBorderAlpha = 1;
    graph.bulletBorderThickness = 2;
    graph.bulletSizeField = "bulletSize";
    graph.balloonText = "<b>[[activity]]</b><br>ROP [[rop]]";
    graph.title = "Rop";
    graph.valueField = "rop";
    graph.lineThickness = 2;
    graph.lineColor = "#00BBCC";
    graph.lineColorField = "lineColor";
    chart.addGraph(graph);

    // CURSOR
    var chartCursor = new AmCharts.ChartCursor();
    chartCursor.cursorPosition = "mouse";
    chart.addChartCursor(chartCursor);

    // SCROLLBAR
    var chartScrollbar = new AmCharts.ChartScrollbar();
    chart.addChartScrollbar(chartScrollbar);

    // WRITE
    chart.write("ropchart");

      var label = $("tspan:contains('chart by amcharts.com')");
      if (label.length > 0) {
          label.remove();
      }

    <% end %>
  <% end %>
</script>


