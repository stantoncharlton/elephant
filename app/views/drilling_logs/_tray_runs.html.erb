<div id="drilling_runs" class="job-tray" data-tray="drilling-runs">

  <div class="drilling-runs-loading hidden">
    <br><br>
    <%= render 'layouts/inline_loading', title: "Please wait, loading runs..." %>
  </div>

  <div class="content">

    <% runs = drilling_log.get_runs %>

    <div class='well'>

      <h1 class="donut-text inline"><%= runs.length %></h1>

      <div class='inline-block push-down push-right-small'>
        <h3 class="inline-block">Runs</h3>
      </div>

    </div>


    <% if runs.any? %>
        <% runs.each_with_index do |run, index| %>
            <% entries = run %>
            <% log = DrillingLog.calculate(run) %>
            <% first_entry = run[0] %>
            <% last_entry = run[run.length - 1] %>

            <% issues = Issue.includes(job: :well).where("wells.id = ?", drilling_log.job.well_id).where("issues.failure_at >= :start AND issues.failure_at <= :end", start: first_entry.entry_at, end: last_entry.entry_at) %>

            <div class="page_header">
              <h1>
                Run <%= index + 1 %>
              </h1>
              <h2 class='push-right'>
                <%= ((last_entry.entry_at - first_entry.entry_at).to_f / 60.0 / 60.0).round(1) %> hours
              </h2>
              <h2 class='inline-block push-right'>BHA <%= !first_entry.bha.nil? ? first_entry.bha.name : '-' %></h2>
              <div class='inline-block pull-right'>
                <%= first_entry.entry_at.strftime("%m/%d/%Y %l:%M %p") %>
                - <%= last_entry.entry_at.strftime("%m/%d/%Y %l:%M %p") %>
              </div>
            </div>

            <div>
              <div class="chart-block tooltip-info"
                   data-title="Average Total Rate of Penetration.">
                <div class="chart-title">Avg Total ROP</div>
                <div class="donut-chart-div job-donut-chart-div">
                  <div class="donut-text "><%= log.nil? || log.rop.nil? ? "-" : log.rop.round(1) %></div>
                  <div class="percentage ">ft/min</div>
                </div>
              </div>

              <div class="chart-block tooltip-info"
                   data-title="Total feet drilled.">
                <div class="chart-title">Total Drilled</div>
                <div class="donut-chart-div job-donut-chart-div">
                  <div class="donut-text "><%= log.nil? || log.total_drilled.nil? ? "-" : log.total_drilled.to_i %></div>
                  <div class="percentage "><span class="push-right-small">ft</span></div>
                </div>
              </div>

              <div class="chart-block tooltip-info"
                   data-title="Time in hours spent rotating or sliding.">
                <div class="chart-title">Drilling Time</div>
                <div class="donut-chart-div job-donut-chart-div">
                  <div class="donut-text "><%= log.nil? || log.drilling_time.nil? ? "-" : log.drilling_time.round(1) %></div>
                  <div class="percentage ">hours</div>
                </div>
              </div>

              <div class="chart-daily tooltip-info" data-title="ROP">
                <canvas id="canvas_<%= index %>" height="110" width="220"></canvas>
              </div>


              <script>
                  <% rops = [] %>
                  <% last_entry = entries.first %>
                  <% entries.each do |dl| %>
                  <% rops << [dl.entry_at, dl == last_entry ? 0.0 : ((dl.depth - last_entry.depth).to_f / (dl.entry_at - last_entry.entry_at).to_f)] %>
                  <% last_entry = dl %>
                  <% end %>

                  var lineChartData = {
                      labels: <%= raw rops.map { |dl| "" }.to_json.html_safe %>,
                      datasets: [
                          {
                              fillColor: "rgba(220,220,220,0.5)",
                              strokeColor: "rgba(220,220,220,1)",
                              pointColor: "rgba(220,220,220,1)",
                              pointStrokeColor: "#fff",
                              data: <%= raw rops.map { |dl| dl[1] }.to_json.html_safe %>
                          }
                      ]
                  }

                  var myLine = new Chart(document.getElementById("canvas_<%= index %>").getContext("2d")).Line(lineChartData, { scaleShowLabels: false });
              </script>


            </div>
            <% if true %>
                <br><br>

                <div>

                  <div class='inline-block'>
                    <div class="chart-title">Time Breakdown</div>
                    <div class='time-chart' id="time_chart2" style="width: 200px; height: 200px;"></div>
                  </div>

                  <div class="chart-block tooltip-info align-top"
                       data-title="Total Number of Failures.">
                    <div class="chart-title">Failures</div>
                    <div class="donut-chart-div job-donut-chart-div">
                      <div class="donut-text chart-text-red"><%= issues.count %></div>
                      <div class="percentage chart-text-red"></div>
                    </div>
                  </div>

                  <script type="text/javascript">
                      var chart = new AmCharts.AmPieChart();
                      chart.dataProvider = <%= raw log.get_times(entries).map{ |k, v| {time: v[:time].round(2), text: v[:activity_code_string]} }.to_a.to_json.html_safe %>;
                      chart.colors = ["#f7464a", "#46bfbd", "#fdb45c", "#24bfe0", "#949fb1", "#4d5360", "#e5dfdb"];
                      chart.titleField = "activity";
                      chart.valueField = "time";
                      chart.sequencedAnimation = false;
                      chart.startDuration = 0;
                      chart.innerRadius = "30%";
                      chart.labelsEnabled = false;
                      chart.balloonText = "<b>[[text]]</b><br><span style='font-size:14px'>([[time]] hours)</span>";
                      chart.write("time_chart2");

                      var label = $("g[cursor=pointer]");
                      if (label.length > 0) {
                          var tspan = label.find('tspan');
                          if (tspan.length > 0) {
                              label.remove();
                          }
                      }
                  </script>
                </div>
            <% end %>
            <br><br>
        <% end %>
    <% else %>
        <p class='help-text'>No runs...</p>
    <% end %>
  </div>
</div>
