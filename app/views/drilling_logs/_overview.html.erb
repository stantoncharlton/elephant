<div id="drilling_overview">
  <div class="pull-right tooltip-info" data-title="ROP">
    <canvas id="overview_rop_canvas" height="110" width="270"></canvas>
  </div>

  <div class="chart-block tooltip-info"
       data-title="Average Total Rate of Penetration.">
    <div class="chart-title">Avg Total ROP</div>
    <div class="donut-chart-div job-donut-chart-div">
      <div class="donut-text "><%= drilling_log.nil? || drilling_log.rop.nil? ? "-" : drilling_log.rop.round(1) %></div>
      <div class="percentage ">ft/min</div>
    </div>
  </div>

  <div class="chart-block tooltip-info"
       data-title="Total feet drilled.">
    <div class="chart-title">Total Drilled</div>
    <div class="donut-chart-div job-donut-chart-div">
      <div class="donut-text "><%= drilling_log.nil? || drilling_log.total_drilled.nil? ? "-" : number_with_delimiter(drilling_log.total_drilled.to_i, :delimiter => ',') %></div>
      <div class="percentage "><span class="push-right-small">ft</span></div>
    </div>
  </div>

  <div class="chart-block tooltip-info"
       data-title="Time in hours spent rotating and sliding.">
    <div class="chart-title">Drilling Time</div>
    <div class="donut-chart-div job-donut-chart-div">
      <div class="donut-text "><%= drilling_log.nil? || drilling_log.drilling_time.nil? ? "-" : drilling_log.drilling_time.round(1) %></div>
      <div class="percentage ">hours</div>
    </div>
  </div>
</div>

<script type='text/javascript'>
    <% if drilling_log.present? && drilling_log.drilling_log_entries.any? %>
    <% rops = [] %>
    <% last_entry = drilling_log.drilling_log_entries.first %>
    <% drilling_log.drilling_log_entries.each do |dl| %>
    <% time = (dl.entry_at - last_entry.entry_at).to_f / 60.0 / 60.0 %>
    <% if dl.activity_code == DrillingLogEntry::DRILLING || dl.activity_code == DrillingLogEntry::SLIDING || time > 0.1 %>
    <% rop = ((dl.depth - last_entry.depth).to_f / (dl.entry_at - last_entry.entry_at).to_f * 60.0)  %>
    <% puts rop %>
    <% rops << [dl.entry_at, dl.activity_code == DrillingLogEntry::DRILLING || dl.activity_code == DrillingLogEntry::SLIDING ? rop : 0.0] %>
    <% end %>
    <% last_entry = dl %>
    <% end %>

    var lineChartData = {
        labels: <%= raw rops.map { |dl| '' }.to_json.html_safe %>,
        datasets: [
            {
                fillColor: "rgba(220,220,220,0.5)",
                strokeColor: "rgba(220,220,220,1)",
                pointColor: "rgba(220,220,220,1)",
                pointStrokeColor: "#fff",
                data: <%= raw rops.map { |dl| dl[1] }.to_json.html_safe %>
            }
        ]
    }

    var myLine = new Chart(document.getElementById("overview_rop_canvas").getContext("2d")).Line(lineChartData, { pointDot: false, scaleShowGridLines: false, animation: false, scaleOverride: true, scaleSteps: 4, scaleStepWidth: 5, scaleStartValue: -4 });

    <% end %>

</script>