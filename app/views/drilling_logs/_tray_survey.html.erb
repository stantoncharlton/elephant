<div class="remote-tray" data-tray="survey">

  <div class="remote-loading hidden">
    <br><br>
    <%= render 'layouts/inline_loading', title: "Please wait, loading survey..." %>
  </div>

  <div class='content tray-content content-loaded'>

    <% @survey = Survey.includes(document: {job: :well}).where(:plan => false).where("wells.id = ?", @drilling_log.job.well_id).first %>
    <% @active_well_plan = Survey.includes(document: {job: :well}).where(:plan => true).where("wells.id = ?", @drilling_log.job.well_id).first %>

    <% if @survey.nil? %>
        <% @document = Document.where("documents.job_id = ?", @drilling_log.document.job_id).where("documents.document_type = ?", Document::SURVEY).last %>
        <% @survey = Survey.new(name: @document.name, plan: false) %>
        <% @survey.company = current_user.company %>
        <% @survey.document = @document %>
        <% @survey.save %>
    <% end %>

    <% if (@active_well_plan.nil? || @active_well_plan.survey_points.empty?) && !@survey.no_well_plan %>
        <br>

        <h3>No Well Plan</h3>

        <p>Please add a well plan before continuing with survey.</p>


        <% document = Document.where("documents.job_id = ?", @drilling_log.document.job_id).where("documents.document_type = ?", Document::WELL_PLAN).last %>
        <% if !document.nil? %>
            <br>
            <%= link_to "Update " + document.name, "/surveys?document=" + document.id.to_s, class: "bluebtn" %>
        <% end %>

        <br><br>
        or
        <br><br>
        <%= link_to "Straight Well - No Well Plan", job_path(@drilling_log.document.job, update_field: true, field: "no_well_plan", value: true),
                    :method => :put,
                    class: "bluebtn gray" %>
    <% else %>

        <% calculated_points = @survey.no_well_plan ? [] : @active_well_plan.survey_points %>
        <% calculated_points_survey = @survey.calculated_points(@survey.no_well_plan ? 0 : @active_well_plan.vertical_section_azimuth) %>


        <% if @survey.survey_points.empty? %>
            <%= render 'surveys/tie_in' %>
        <% end %>

        <div>
          <div class="btn-group inline pull-right push-right">
            <a class="custom-data-toggle-jobs" data-toggle="dropdown" href="#">
              Export
            </a>
            <ul class="dropdown-menu">
              <li>
                <%= link_to "Export as Excel", survey_path(@survey, format: "xlsx"),
                            target: "_blank",
                            class: "dropdown-menu-link tooltip-info submit-form",
                            "data-placement" => "left",
                            "data-title" => "Export survey as Microsoft Excel file." %>
              </li>
            </ul>
          </div>

          <div class='pull-right'>
            <% if @survey.no_well_plan %>
                <b>Straight Well - No Well Plan</b>
            <% else %>
                <p class='inline-block help-text align-top'><%= @survey.name %></p>

                <%= link_to "View Well Plan", @active_well_plan, class: "btn btn-default align-top push-up-small push-right-small" %>
            <% end %>
          </div>
          <span><div class='well-plan'></div> Well Plan</span>
          <span class='push-right-small'><div class='active-survey'></div> Survey</span>
        </div>
        <hr>

        <% if calculated_points_survey.any? || calculated_points.any? %>
            <div id="chartdiv" class='inline-block' style="width: 420px; height: 400px;"></div>
            <div id="chartdiv2" class='inline-block' style="width: 420px; height: 400px;"></div>
        <% end %>


        <div class='push-down'>
          <div class="list-item-column list-item-column-short">M. Depth</div>
          <div class="list-item-column list-item-column-short3">Inc</div>
          <div class="list-item-column list-item-column-short3">Azi</div>
          <div class="list-item-column list-item-column-short">TVD</div>
          <div class="list-item-column list-item-column-short">V Sect</div>
          <div class="list-item-column list-item-column-short">+N/S-</div>
          <div class="list-item-column list-item-column-short">+E/W-</div>
          <div class="list-item-column list-item-column-count">DLS</div>
          <div class="list-item-column list-item-column-count">MFS</div>
          <div class="list-item-column list-item-column-count">Dip</div>
          <div class="list-item-column list-item-column-count">Grav</div>
        </div>
        <hr>


        <%= render 'surveys/survey_list', points: calculated_points_survey %>

        <br><br>

        <% if @survey.survey_points.empty? %>
            <div id="survey_entry" class="hidden">
            </div>
        <% else %>
            <%= render 'surveys/survey_entry' %>
        <% end %>

        <% if !@survey.survey_points.empty? %>
            <%= render 'surveys/charting', calculated_points_survey: calculated_points_survey, calculated_points: calculated_points %>
        <% end %>
    <% end %>

    <script type='text/javascript'>
        <% if @survey.present? && @survey.document.job.status == Job::ON_JOB %>
        setTimeout(function () {
            $.ajax({
                url: "/surveys/<%= @survey.id %>",
                type: "GET",
                dataType: "script"
            });
        }, 1000 * 60 * 5);
        <% end %>
    </script>

  </div>
</div>