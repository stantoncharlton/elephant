<% if @district.present? %>
    <% parts = @district.parts %>
<% else %>
    <% parts = current_user.company.parts %>
<% end %>
<% on_hand = parts.where(:status => Part::AVAILABLE).count %>

<% provide(:title, 'Inventory') %>

<div class="page_header">
  <h1>Inventory</h1>

  <% if @district.present? %>
      <div class="pull-right">
        <h3 class="inline push-left-small">&nbsp;District</h3>
        <%= link_to @district.name, @district, class: "activity-user-link" %>
      </div>
  <% end %>
</div>


<div class="well">


  <% if @district.present? %>
      <%= link_to "+ Add New Master Asset", new_part_path(template: true, district: @district.id),
                  class: "bluebtn tooltip-info pull-right",
                  "data-placement" => "bottom",
                  "data-title" => "Create new asset" %>
  <% end %>

  <div>
    <b>Assets</b>
    <div class="filter-search-box">
      <% if @district.present? %>
          <%= text_field_tag "", "", data: {autocomplete_source: parts_path(district_id: @district.id)},
                             placeholder: "Search for asset...",
                             class: "txtfield search-query tooltip-info part-search",
                             id: "part_search",
                             "data-placement" => "left",
                             "data-title" => "Search in asset..." %>
      <% else %>
          <%= text_field_tag "", "", data: {autocomplete_source: parts_path},
                             placeholder: "Search for asset...",
                             class: "txtfield search-query tooltip-info part-search",
                             id: "part_search",
                             "data-placement" => "left",
                             "data-title" => "Search in assets..." %>
      <% end %>
    </div>
  </div>
</div>


<br>

<div class="chart-block tooltip-info"
     data-title="Total assets in district inventory">
  <div class="chart-title">Assets</div>
  <div class="donut-chart-div">
    <div class="donut-text "><%= number_with_delimiter(parts.count, :delimiter => ",") %></div>
    <div class="percentage ">assets</div>
  </div>
</div>

<div class="chart-block tooltip-info"
     data-title="Total assets in district available for use.">
  <div class="chart-title">Assets On Hand</div>
  <div class="donut-chart-div">
    <div id="personnel_utilization" class="donut-chart "></div>
    <div class="donut-inner-circle"></div>
    <div class="donut-text"><%= parts.any? ? ((on_hand.to_f / parts.count.to_f) * 100).round(0) : "0" %></div>
    <div class="percentage-circle">%</div>
  </div>
</div>

<div class="chart-block tooltip-info"
     data-title="Average days to redress asset.">
  <div class="chart-title">Average Assets Redress</div>
  <div class="donut-chart-div">
    <div class="donut-text "><%= @average_redress %></div>
    <div class="percentage ">days</div>
  </div>
</div>

<% if @district.present? %>
    <div class="content">
      <br>
      <%= link_to 'View Full Inventory List (' + number_with_delimiter(parts.count, :delimiter => ",") + ')', 'inventory/' + @district.id.to_s, class: "activity-user-link orange-text job-title job-title4" %>
    </div>
<% end %>


<div class="content">
  <h3>Recently Shipped</h3>
</div>

<hr>

<div class="content" id="jobs">
  <% @jobs.each do |job| %>
      <%= render 'jobs/job_progress_link', job: job %>
  <% end %>
</div>




<script>
    $(document).ready(function () {
        var plot3 = $.jqplot('personnel_utilization', [
            [
                ['a', <%= parts.count %>],
                ['b', <%= parts.count - on_hand %>]
            ]
        ], {
            animate: true,
            animateReplot: true,
            background: "#FFFFFF",
            seriesColors: [ "#458fd2", "#FFFFFF"],
            seriesDefaults: {
                textColor: " #00ff0000",
                shadow: false,
                renderer: $.jqplot.DonutRenderer,
                rendererOptions: {
                    animation: {
                        show: true,
                        speed: 2500
                    },
                    padding: 0,
                    innerDiameter: 95,
                    sliceMargin: 0,
                    startAngle: -90,
                    showDataLabels: true,
                    dataLabels: 'value'
                }
            }
        });

    });
</script>


<script type="text/javascript">
    (function ($) {
        $(document).ready(function () {
            $('.part-search').data("autocomplete")._renderItem = function (ul, item) {
                return $("<li class='item_" + item.id + "'></li>").data("item.autocomplete", item).append(
                        "<a><div>" + (item.id > 0 ? "<img src='/assets/tool.png' class='job-member-avatar pull-left'>" : "") + "</div><div><div class='job-user'><strong>" + item.value + " </strong>" + (item.id > 0 ? "<p class='job-user-district pull-right'><span class='help-text'>Material # </span>" + item.material_number + "</p>" : "") + (item.id > 0 ? "<div>" + (item.serial_number != null ? ("<p class='job-user-title'><span class='help-text'>Serial # </span><b class='orange-text'>" + item.serial_number + "</b> / <span class='help-text'>District # </span><b class='orange-text'>" + item.district_serial_number + "</b></p>") : "<p class='job-user-title'><b class='blue-text'>Master Part</b></p>") + "</div>" : "") + "</div></div></a>").appendTo(ul)
            }
        });
    }(jQuery));
</script>
