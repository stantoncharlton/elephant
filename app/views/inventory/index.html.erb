<% if @district.present? %>
    <% if current_user.role.district_read? %>
        <% if @district.master_district.present? %>
            <% parts = Part.where(:company_id => current_user.company_id).where("parts.district_id = :district_id", district_id: @district.id).where(:template => false) %>
        <% else %>
            <% parts = Part.where(:company_id => current_user.company_id).where("parts.district_id IN (SELECT id FROM districts where master_district_id = :district_id)", district_id: @district.id).where(:template => false) %>
        <% end %>
    <% else %>
        <% parts = @district.parts.where(:template => false) %>
    <% end %>
<% else %>
    <% parts = current_user.company.parts %>
<% end %>
<% on_hand = parts.where(:status => Part::AVAILABLE).count %>

<% provide(:title, 'Inventory') %>


<div class="">

  <div>
    <b>Assets</b>

    <div class="filter-search-box">
      <% if @district.present? %>
          <%= text_field_tag "", "", data: {autocomplete_source: parts_path(district_id: @district.id)},
                             placeholder: "Search for asset...",
                             class: "txtfield search-query tooltip-info part-search",
                             id: "part_search",
                             "data-placement" => "left",
                             "data-title" => "Search in asset..." %>
      <% else %>
          <%= text_field_tag "", "", data: {autocomplete_source: parts_path},
                             placeholder: "Search for asset...",
                             class: "txtfield search-query tooltip-info part-search",
                             id: "part_search",
                             "data-placement" => "left",
                             "data-title" => "Search in assets..." %>
      <% end %>
    </div>
  </div>
</div>
<hr>


<div class="page_header">
  <h1>Inventory</h1>

  <% if @district.present? %>
      <span><%= @district.name %></span>

      <div class="btn-group inline pull-right push-right-small">
        <a class="custom-data-toggle-jobs" data-toggle="dropdown" href="#">
          Advanced Actions
        </a>
        <ul class="dropdown-menu">
          <% if !@district.nil? %>
              <li>
                <%= link_to "Create new warehouse", new_warehouse_path(district: @district),
                            class: "dropdown-menu-link tooltip-info",
                            "data-placement" => "left",
                            "data-title" => "Create new master asset." %>
              </li>
          <% end %>
        </ul>
      </div>
  <% end %>
</div>

<% if @district.present? %>
    <div class="">
      <b class="inline">District</b>
      <%= link_to @district.name, @district, class: "activity-user-link" %>

      <% if current_user.role.district_read? %>
          <% if @district.master? %>
              <br>
              <b class=''>Warehouses</b>
              <% @district.warehouses.each_with_index do |warehouse, i| %>
                  <%= link_to warehouse, class: "activity-user-link" do %>
                      <%= i < @district.warehouses.count - 1 ? warehouse.name + "," : warehouse.name %>
                  <% end %>
              <% end %>
          <% end %>
      <% end %>
    </div>
<% end %>

<% if current_user.role.global_read? %>
    <div class="">
      Jump to Different Inventory:
      <br><br>

      <div class="district-jump">
        <%= hidden_field_tag "district_id", id: "district_id" %>
      </div>
      <%= image_tag "district_extrasmall.png", class: "job-status-avatar" %>
      <%= text_field_tag "", "", data: {autocomplete_source: districts_path},
                         placeholder: "Type a district name...",
                         id: "district_name",
                         class: "txtfield small tooltip-info district-jump-to",
                         "data-placement" => "top",
                         "data-title" => "District Name, select from drop down based on search results" %>

      or &nbsp;

      <%= select_tag "District",
                     options_for_select(current_user.company.districts.where(:master => true).collect { |d| [d.name, d.id] }),
                     class: "tooltip-info custom-select",
                     id: "jump_to_district_select",
                     "data-placement" => "bottom",
                     "data-title" => "Select a District",
                     prompt: "Select district..." %>
    </div>
<% end %>

<br>

<div class="well">
  <div class="chart-block tooltip-info"
       data-title="Total assets in district inventory">
    <div class="chart-title">Assets</div>
    <div class="donut-chart-div">
      <div class="donut-text "><%= number_with_delimiter(parts.count, :delimiter => ",") %></div>
      <div class="percentage ">assets</div>
    </div>
  </div>

  <div class="chart-block tooltip-info"
       data-title="Total assets in district available for use.">
    <div class="chart-title">Assets On Hand</div>
    <div class="donut-chart-div">
      <div id="personnel_utilization" class="donut-chart "></div>
      <div class="donut-inner-circle"></div>
      <div class="donut-text"><%= parts.any? ? ((on_hand.to_f / parts.count.to_f) * 100).round(0) : "0" %></div>
      <div class="percentage-circle">%</div>
    </div>
  </div>

  <div class="chart-block tooltip-info"
       data-title="Average days to redress asset.">
    <div class="chart-title">Average Assets Redress</div>
    <div class="donut-chart-div">
      <div class="donut-text "><%= @average_redress %></div>
      <div class="percentage ">days</div>
    </div>
  </div>
</div>

<% if @district.present? %>
    <div class="content">
      <br>
      <%= link_to 'View Full Inventory List (' + number_with_delimiter(parts.count, :delimiter => ",") + ')', 'inventory/' + @district.id.to_s, class: "activity-user-link orange-text job-title job-title4" %>
    </div>
<% end %>


<div class="content">
  <h3>Recently Shipped</h3>
</div>

<hr>

<div class="content" id="jobs">
  <% @jobs.each do |job| %>
      <%= render 'jobs/job_progress_link', job: job %>
  <% end %>
</div>

<% if @jobs.empty? %>
    <div class='center help-text'>No recently shipped jobs...</div>
<% end %>




<script>
    $(document).ready(function () {
        var plot3 = $.jqplot('personnel_utilization', [
            [
                ['a', <%= parts.count %>],
                ['b', <%= parts.count - on_hand %>]
            ]
        ], {
            animate: true,
            animateReplot: true,
            background: "#FFFFFF",
            seriesColors: [ "#458fd2", "#FFFFFF"],
            seriesDefaults: {
                textColor: " #00ff0000",
                shadow: false,
                renderer: $.jqplot.DonutRenderer,
                rendererOptions: {
                    animation: {
                        show: true,
                        speed: 2500
                    },
                    padding: 0,
                    innerDiameter: 95,
                    sliceMargin: 0,
                    startAngle: -90,
                    showDataLabels: true,
                    dataLabels: 'value'
                }
            }
        });

    });
</script>


<script type="text/javascript">
    (function ($) {
        $(document).ready(function () {
            $('.part-search').data("autocomplete")._renderItem = function (ul, item) {
                return $("<li class='item_" + item.id + "'></li>").data("item.autocomplete", item).append(
                        "<a><div>" + (item.id > 0 ? "<img src='/assets/tool.png' class='job-member-avatar pull-left'>" : "") + "</div><div><div class='job-user'><strong>" + item.value + " </strong>" + (item.id > 0 ? "<p class='job-user-district pull-right'><span class='help-text'>Material # </span>" + item.material_number + "</p>" : "") + (item.id > 0 ? "<div>" + (item.serial_number != null ? ("<p class='job-user-title'><span class='help-text'>Serial # </span><b class='orange-text'>" + item.serial_number + "</b> / <span class='help-text'>District # </span><b class='orange-text'>" + item.district_serial_number + "</b></p>") : "<p class='job-user-title'><b class='blue-text'>Master Part</b></p>") + "</div>" : "") + "</div></div></a>").appendTo(ul)
            }
        });
    }(jQuery));
</script>


<script type="text/javascript">
    (function ($) {
        $(document).ready(function () {
            $('#district_name').data("autocomplete")._renderItem = function (ul, item) {
                return $("<li class='item_" + item.id + "'></li>").data("item.autocomplete", item).append(
                        "<a><div>" + (item.id > 0 ? "<img src='/assets/district_extrasmall.png' class='job-member-avatar pull-left'>" : "") + "</div><div><div class='job-user'><strong>" + item.value + " </strong>" + (item.id > 0 ? "<div><p class='job-user-title'>" + item.country + ", " + item.state + "  " + item.city + "</p><p class='job-user-district'>" + item.region + "</p></div>" : "") + "</div></div></a>").appendTo(ul)
            }
        });
    }(jQuery));
</script>
