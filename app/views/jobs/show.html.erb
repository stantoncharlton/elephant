<div class="content">
  <%= render 'job_data', job: @job, form_editable: @job_editable %>
</div>

<div class="content">
  <p class="job-field-title pull-left">Project Members</p>

  <div class="job-members-div pull-left">
    <ul class="job-members-list" id="job_members_list">
      <% @job.job_memberships.each do |jm| %>
          <% if jm.job_role_id != 6 %>
              <%= render 'jobs/member', job_membership: jm %>
          <% end %>
      <% end %>
    </ul>

    <% if @job_editable %>

        <%= link_to "Add Member", new_job_membership_path, remote: true,
                    class: "add-job-member", id: "add_job_member" %>
    <% end %>


    <%= form_for(@job_member, :html => {:class => "inline hidden new-job-member ", id: "new_member_form"}, remote: true) do |f| %>
        <%= f.hidden_field :job_id, id: "new_member_job_id", value: @job.id %>
        <%= f.hidden_field :user_id, id: "new_member_id" %>
        <%= text_field_tag "", "", data: {autocomplete_source: users_path},
                           placeholder: "Type a name...",
                           id: "new_member_name", class: "txtfield small" %>
        <%= f.select :job_role_id, options_for_select([["Observer", 1], ["Supervisor", 2], ["Coordinator", 3], ["Field", 4], ["Shop", 5]]),
                     prompt: "Select a job role...",
                     class: "job-note-type" %>
        <%= f.submit "Add", class: "bluebtn btnsmall move-up" %>
    <% end %>
  </div>
</div>


<div class="content">
  <div class="">
    <a href="#" id="custom_data_toggle" class="custom-data-toggle">More Job Details</a>

    <div class="custom-data-closed" id="custom_data">
      <% @job.dynamic_fields.each do |df| %>
          <% if !df.dynamic_field_template.priority? %>
              <p class="job-field-title"><%= df.dynamic_field_template.name %></p>
              <% if @job_editable %>
                  <input id="dynamic_field_<%= df.id %>" type="text" class="job-field-value-editable custom-data-input"
                         value="<%= df.value.present? ? df.value : "-" %>">
              <% else %>
                  <p class="job-field-value"><%= df.value %></p>
              <% end %>
          <% end %>
      <% end %>
    </div>
  </div>
</div>

<div id="process_actions" class="">

  <% @job.job_processes.select { |jp| jp.event_type == JobProcess::APPROVED_TO_SHIP }.each do |job_process| %>
      <%= render 'job_process/job_shipped', job_process: job_process %>
  <% end %>
  <% @job.job_processes.select { |jp| jp.event_type == JobProcess::APPROVED_TO_CLOSE }.each do |job_process| %>
      <%= render 'job_process/job_closed', job_process: job_process %>
  <% end %>
</div>

<div class="header">
  <h2>Documents</h2>

  <% if @job_editable %>
      <div class="pull-right">
        <%= link_to "Add Custom Document", new_document_path(modal: true, job_id: @job.id),
                    remote: true,
                    class: "add-custom-document" %>
      </div>
  <% end %>
</div>

<% if @field_bulletin_documents.any? %>
    <h3 class="document-section-header">Field Bulletins</h3>
    <div class="content" id="documents3">
      <% @field_bulletin_documents.sort_by { |e| e[:created_at] }.each do |d| %>
          <%= render 'documents/document', document: d, editable: false %>
      <% end %>
    </div>
<% end %>

<% if @pre_job_documents.all? { |d| d.url.present? } %>
    <h3 class="document-section-header status-good">Pre-Job</h3>
<% else %>
    <h3 class="document-section-header">Pre-Job</h3>
<% end %>
<div class="content" id="documents">
  <% @pre_job_documents.sort_by { |e| e[:created_at] }.each do |d| %>
      <%= render 'documents/document', document: d, editable: false %>
  <% end %>
</div>

<% if @post_job_documents.all? { |d| d.url.present? } %>
    <h3 class="document-section-header status-good">Post-Job</h3>
<% else %>
    <h3 class="document-section-header">Post-Job</h3>
<% end %>
<div class="content" id="documents2">
  <% @post_job_documents.sort_by { |e| e[:created_at] }.each do |d| %>
      <%= render 'documents/document', document: d, editable: false %>
  <% end %>
</div>


<div class="header">
  <h2>Notes/Action Items</h2>
</div>
<div class="content">
  <div class="field">
    <% if @job_editable %>
        <%= form_for(@job_note, :html => {class: "", id: "new_note_form"}, remote: true) do |f| %>
            <div class="new-product-line">
              <%= f.hidden_field :job_id, value: @job.id %>
              <%= f.hidden_field :assign_to_id, id: "new_note_name_id" %>

              <%= f.text_area :text, placeholder: "Type note here...", class: "txtfield job-notes-text", autofocus: false,
                              id: "new_note_id" %>

              <div class="job-note-options">
                <%= f.select :note_type, options_for_select([["Note", 1], ["Task", 4], ["Warning", 2], ["Problem", 3]]),
                             class: "job-note-type" %>
                <%= text_field_tag "", "", data: {autocomplete_source: users_path},
                                   placeholder: "Type a name to assign...",
                                   id: "new_note_name",
                                   class: "job-field-value-editable custom-data-input job-note-assign" %>
              </div>

              <%= f.submit "Add", class: "bluebtn btnsmall pull-right" %>


            </div>
        <% end %>
    <% elsif @job.job_notes.empty? %>
        <div class="no-alerts">
          <p class="center">No job notes...</p>
        </div>
    <% end %>
  </div>
</div>
<div id="job_notes" class="content">
  <% @job.job_notes.each do |job_note| %>
      <%= render 'job_notes/job_note', job_note: job_note %>
  <% end %>
</div>



<%= render 'activities/paginated_activity', activities: @activities, inside_job: true %>

<script type="text/javascript">
    (function ($) {
        $(document).ready(function () {


            // Needed in view because otherwise it conflicts with jquery menu. No idea?
            $('#new_member_name').data("autocomplete")._renderItem = function (ul, item) {
                return $("<li></li>").data("item.autocomplete", item).append(
                        "<a><div class='job-user'><strong>" + item.value + " </strong><div><p class='job-user-title'>" + item.position_title + "</p><p class='job-user-district'>" + item.district + "</p></div></div></a>").appendTo(ul)
            }
            $('#new_note_name').data("autocomplete")._renderItem = function (ul, item) {
                return $("<li></li>").data("item.autocomplete", item).append(
                        "<a><div class='job-user'><strong>" + item.value + " </strong><div><p class='job-user-title'>" + item.position_title + "</p><p class='job-user-district'>" + item.district + "</p></div></div></a>").appendTo(ul)
            }

            $.ajax({
                url:"/job_process/" + <%= @job.id.to_s %>,
                type:"GET",
                dataType:"script"
            });

        });
    }(jQuery));
</script>



