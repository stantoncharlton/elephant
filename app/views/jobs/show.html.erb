<% provide(:title, "Job | " + @job.field.name + " | " + @job.well.name) %>

<%= render 'jobs/job_header', job: @job, form_editable: @job_editable, in_form: true, new_line_job_type: false %>

<div style='height: 52px;'>
  <div style='position: absolute; left: 0; width: 100%; height: 52px;'>
    <ul class="nav nav-pills alert alert-nav alert-nav-shrink" style='border-radius: 0px; border-width: 0px;'>

      <% drilling_log_document = Document.where("documents.job_id = ?", @job.id).where("documents.document_type = ?", Document::DRILLING_LOG).first %>
      <% if !drilling_log_document.nil? %>
          <div class='inline-block pull-right'>
            <li class="">
              <a href="<%= drilling_logs_path(document: drilling_log_document.id, :anchor => "drilling-overview") %>" class=" custom-data-toggle tooltip-info"
                 style=" background: #f4bb0d; width: 100px; margin-right: -35px;"
                 data-placement="bottom" data-title="Drilling Data">Open Drilling
              </a>
            </li>
          </div>
      <% end %>

      <li class="active">
        <a href="#overview" class="job-tray-toggle custom-data-toggle tooltip-info"
           data-tray="overview"
           data-placement="bottom" data-title="Job Overview">Overview
        </a>
      </li>

      <li class="">
        <a href="#documents_data" class="job-tray-toggle custom-data-toggle tooltip-info"
           data-tray="documents_data"
           data-placement="bottom" data-title="Custom job data and values">Documents
        </a>
      </li>

      <li class="">
        <a href="#custom_data" id="custom_data_toggle" class="job-tray-toggle custom-data-toggle tooltip-info"
           data-tray="custom_data"
           data-placement="bottom" data-title="Custom job data and values"><%= "Job Info" %>
        </a>
      </li>

      <li class="">
        <a href="#tools_assets" id="job_tools_toggle" class="job-tray-toggle custom-data-toggle tooltip-info"
           data-tray="tools_assets"
           data-placement="bottom" data-title="List of tools used on this job">Tools/Assets
        </a>
      </li>

      <li class="">
        <a href="#job_failures" id="job_tools_toggle" class="job-tray-toggle custom-data-toggle tooltip-info"
           data-tray="job_failures"
           data-placement="bottom" data-title="List of job failures">Failures
        </a>
      </li>

      <li class="">
        <a href="#notes" class="job-tray-toggle custom-data-toggle tooltip-info"
           data-tray="notes"
           data-placement="bottom" data-title="Daily Status, Requests, Notes, and Tasks for this job">Daily Notes
        </a>
      </li>

      <li class="">
        <a href="#cost" class="job-tray-toggle custom-data-toggle tooltip-info"
           data-tray="cost"
           data-placement="bottom" data-title="Job Cost">Cost</a>
      </li>

      <li class="">
        <a href="#reports" class="job-tray-toggle custom-data-toggle tooltip-info"
           data-tray="reports"
           data-placement="bottom" data-title="Reports">Reports</a>
      </li>


      <li class="">
        <a href="#time" class="job-tray-toggle custom-data-toggle tooltip-info"
           data-tray="time"
           data-placement="bottom" data-title="Time/Scheduling">Timesheet</a>
      </li>

      <li class="">
        <a href="#activity" class="job-tray-toggle custom-data-toggle tooltip-info"
           style='padding: 10px;'
           data-tray="activity"
           data-placement="bottom" data-title="All Job History"><i class="icon-time"></i></a>
      </li>


    </ul>
  </div>
</div>


<div class='' style='height: 40px;'>

  <div class="" style="position: absolute; background: #e7e7e7; top: 312px; left: 0; width: 100%; height: 40px;">


    <div class="btn-group inline pull-right" style='margin-right: 60px; margin-top: 10px;'>
      <a class="custom-data-toggle-jobs" data-toggle="dropdown" href="#">
        Advanced Actions
      </a>
      <ul class="dropdown-menu">

        <li>
          <%= link_to "Create New Job (Rig Skid)", new_job_path(job: @job.id),
                      remote: true,
                      class: "dropdown-menu-link tooltip-info show-modal-button",
                      "data-placement" => "left",
                      "data-title" => "This will allow you to create a new job and transfer all assets, information, and people." %>
        </li>


        <% if @job.status == Job::COMPLETE %>
            <li>
              <%= link_to "Reopen Job", @job,
                          class: "dropdown-menu-link tooltip-info",
                          "data-placement" => "left",
                          "data-title" => "This will reopen the job for edit." %>

              <!--<li class="divider"></li>-->
            </li>
        <% end %>


        <% if @job.is_coordinator_or_creator?(current_user) || current_user.role.district_edit? %>

            <li class="divider"></li>


            <li>
              <%= link_to "Delete Job", @job, method: :delete,
                          class: "btn btn-danger white-text tooltip-info",
                          style: "margin-left: 10px; ",
                          data: {confirm: "Delete Job? Permanently delete job. All data and documents will be lost. This can't be undone."},
                          "data-placement" => "left",
                          "data-title" => "Permanently delete job. All data and documents will be lost. This can't be undone." %>
            </li>
        <% end %>


      </ul>
    </div>

    <div style='margin-left: 20px; margin-top: 8px;'>
      <% jobs = @job.well.jobs.where(:shared => true) %>
      <% if jobs.count > 1 %>
          <div class='' style='margin-top: -2px;'>
            <ul class="nav nav-tabs">
              <div class='pull-right align-top push-down-small' style='margin-right: 30px;'>
                <div class='inline-block' style='margin-right: 4px; background: #b5b5b5; border-radius: 100px; width: 20px; height: 20px; color: #ffffff; text-align: center;'><%= jobs.count.to_s %></div>
                <b>Jobs</b>
              </div>
              <% jobs.each_with_index do |j| %>
                  <li class='<%= @job.job_template == j.job_template ? "active" : "" %>'>
                    <%= link_to j, class: "blue-text" do %>
                        <b><%= j.job_template.name %></b>
                    <% end %>
              <% end %>
            </ul>
          </div>
      <% else %>
          <%= link_to @job.job_template.product_line.name, @job.job_template.product_line, class: "job-title3 inline job-type-description-target empty-link",
                      "data-placement" => "bottom",
                      "data-html" => true,
                      "data-title" => "<div>Product Line <b>" + @job.job_template.product_line.name + "</b></div>" %>

          <p class="inline "> - </p>

          <%= link_to @job.job_template.name, @job.job_template, class: "job-title3 inline job-type-description-target empty-link",
                      "data-placement" => "bottom",
                      "data-html" => true,
                      "data-title" => "<div>Job System <b>" + @job.job_template.name + "</b>, Click to view all jobs</div>" %>
      <% end %>
    </div>

  </div>
</div>


<div id="job_<%= @job.id %>" class="job-main-div">
  <div class="">


    <div class="job-tray" data-tray="overview">

      <div class="page_header">
        <h1>Job Overview</h1>
      </div>

      <%= render 'jobs/duplicate_warning', job: @job %>
      <%= render 'jobs/job_process', job: @job %>


      <%= render 'job_data', job: @job, form_editable: @job_editable, in_form: true, new_line_job_type: false %>


      <%= render 'jobs/job_members', job: @job, job_editable: @job_editable %>

      <hr>

      <div id="job_overview">
        <div class='center'>
          <span class="ajax-loading search-loading"><b>Loading overview...</b></span>
        </div>
      </div>
    </div>



    <%= render 'jobs/job_custom_data', job: @job, job_editable: @job_editable %>

    <div class="job-tray custom-data-closed" data-tray="tools_assets">
      <div id="assets_loading">
        <div class="remote-loading">
          <br><br>

          <div class="loading center">
            <br><br>
            <span class="ajax-loading search-loading"><b>Loading Assets...</b></span>
            <br>
          </div>
          <br><br><br>
          <br><br><br>
        </div>
      </div>
    </div>


    <div class="job-tray custom-data-closed" data-tray="documents_data">
      <div id="documents_loading">
        <div class="remote-loading">
          <br><br>

          <div class="loading center">
            <br><br>
            <span class="ajax-loading search-loading"><b>Loading Documents/Logs...</b></span>
            <br>
          </div>
          <br><br><br>
          <br><br><br>
        </div>
      </div>
    </div>

    <div class="job-tray custom-data-closed" data-tray="notes">
      <div id="notes_loading">
        <div class="remote-loading">
          <br><br>

          <div class="loading center">
            <br><br>
            <span class="ajax-loading search-loading"><b>Loading Daily Notes...</b></span>
            <br>
          </div>
          <br><br><br>
          <br><br><br>
        </div>
      </div>
    </div>

    <div class="job-tray custom-data-closed" data-tray="job_failures">
      <div id="failures_loading">
        <div class="remote-loading">
          <br><br>

          <div class="loading center">
            <br><br>
            <span class="ajax-loading search-loading"><b>Loading Failures...</b></span>
            <br>
          </div>
        </div>
        <br><br><br>
        <br><br><br>
      </div>
    </div>

    <div class="job-tray custom-data-closed" data-tray="cost">
      <div id="cost_loading">
        <div class="remote-loading">
          <br><br>

          <div class="loading center">
            <br><br>
            <span class="ajax-loading search-loading"><b>Loading Cost...</b></span>
            <br>
          </div>
          <br><br><br>
          <br><br><br>
        </div>
      </div>
    </div>

    <div class="job-tray custom-data-closed" data-tray="reports">
      <div id="reports_loading">
        <div class="remote-loading">
          <br><br>

          <div class="loading center">
            <br><br>
            <span class="ajax-loading search-loading"><b>Loading Reports...</b></span>
            <br>
          </div>
          <br><br><br>
          <br><br><br>
        </div>
      </div>
    </div>

    <div class="job-tray custom-data-closed" data-tray="activity">
      <%= render 'activities/paginated_activity', activities: @activities, inside_job: true %>
    </div>

    <%= render 'jobs/job_time', job: @job %>
  </div>
</div>



<div id="modal_popup" class="modal-popup-background">
  <div class="modal-popup modal-popup-fixed">
    <%= link_to "close", "#", class: "delete-button modal-popup-close", id: "close_modal" %>
    <div class="modal-content">
    </div>
    <%= render "layouts/inline_loading", title: "Loading..." %>
  </div>
</div>

<div id="modal_popup2" class="modal-popup-background">
  <div class="modal-popup modal-popup-fixed">
    <%= link_to "close", "#", class: "delete-button modal-popup-close", id: "close_modal2" %>
    <div class="modal-content">
    </div>
    <%= render "layouts/inline_loading", title: "Loading..." %>
  </div>
</div>



<script type="text/javascript">
    (function ($) {
        $(document).ready(function () {

            // Needed in view because otherwise it conflicts with jquery menu. No idea?
            if ($('#new_member_name').length > 0) {
                $('#new_member_name').data("autocomplete")._renderItem = function (ul, item) {
                    return $("<li class='item_" + item.id + "'></li>").data("item.autocomplete", item).append(
                            "<a>" + (item.id > 0 ? "<img src='/assets/user_avatar_extrasmall.png' class='job-member-avatar pull-left'>" : "") + "<div class='job-user'><strong>" + item.value + " </strong>" + (item.id > 0 ? "<div><p class='job-user-title'>" + item.position_title + "</p><p class='job-user-district'>" + item.district + "</p></div>" : "") + "</div></a>").appendTo(ul)
                }
            }
            if ($('#new_note_name').length > 0) {
                $('#new_note_name').data("autocomplete")._renderItem = function (ul, item) {
                    return $("<li class='item_" + item.id + "'></li>").data("item.autocomplete", item).append(
                            "<a>" + (item.id > 0 ? "<img src='/assets/user_avatar_extrasmall.png' class='job-member-avatar pull-left'>" : "") + "<div class='job-user'><strong>" + item.value + " </strong>" + (item.id > 0 ? "<div><p class='job-user-title'>" + item.position_title + "</p><p class='job-user-district'>" + item.district + "</p></div>" : "") + "</div></a>").appendTo(ul)
                }
            }

            setTimeout(function () {

                $.ajax({
                    url: "/jobs/" + <%= @job.id.to_s %> +"?section=overview",
                    type: "GET",
                    dataType: "script"
                });


                <% if false %>
                if (document.location.hash == '') {
                    tray = $(".job-tray[data-tray='documents_data']");
                    tray.find('.content').hide();
                    tray.find('.remote-loading').removeClass('hidden');
                    tray.find('.loading').removeClass('hidden');
                    setTimeout(function () {
                        $.ajax({
                            url: "/jobs/<%= @job.id %>?section=documents_data",
                            type: "GET",
                            dataType: "script"
                        });
                    }, 1);
                }
                <% end %>

                <% if false %>

                $.ajax({
                    url: "/jobs/" + <%= @job.id.to_s %> +"?section=documents",
                    type: "GET",
                    dataType: "script"
                });

                $.ajax({
                    url: "/jobs/" + <%= @job.id.to_s %> +"?section=tools_assets",
                    type: "GET",
                    dataType: "script"
                });

                $.ajax({
                    url: "/jobs/" + <%= @job.id.to_s %> +"?section=notes",
                    type: "GET",
                    dataType: "script"
                });

                $.ajax({
                    url: "/job_times?job=" + <%= @job.id.to_s %>,
                    type: "GET",
                    dataType: "script"
                });

                $.ajax({
                    url: "/jobs/" + <%= @job.id.to_s %> +"?section=failures",
                    type: "GET",
                    dataType: "script"
                });
                <% end %>

            }, 1);

        });
    }(jQuery));
</script>


<script type="text/javascript">
    (function ($) {
        $(document).ready(function () {
            $('.part-match').each(function (index, element) {
                $(element).data("autocomplete")._renderItem = function (ul, item) {
                    return $("<li class='item_" + item.id + "'></li>").data("item.autocomplete", item).append(
                            "<a><div>" + (item.id > 0 ? "<img src='/assets/tool.png' class='job-member-avatar pull-left'>" : "") + "</div><div><div class='job-user'><strong>" + item.value + " </strong>" + (item.id > 0 ? "<div>" + (item.serial_number != null ? ("<p class='job-user-title'><span class='help-text'>Serial # </span><b class='blue-text'>" + item.serial_number + "</b><span class='help-text'>District # </span><b class='blue-text'>" + item.district_serial_number + "</b></p>") : "<p class='job-user-title'><b class='blue-text'>Master Part</b></p>") + "</div>" : "") + "</div></div></a>").appendTo(ul)
                }
            });
        });
    }(jQuery));
</script>


<script type='text/javascript'>

    var oldHide = $.fn.popover.Constructor.prototype.hide;

    $.fn.popover.Constructor.prototype.hide = function () {
        if (this.options.trigger === "hover" && this.tip().is(":hover")) {
            var that = this;
            // try again after what would have been the delay
            setTimeout(function () {
                return that.hide.call(that, arguments);
            }, that.options.delay.hide);
            return;
        }
        oldHide.call(this, arguments);
    };

    var map = L.mapbox.map('map', 'elephant.map-vum3on5g');
    map.attributionControl = false;
    map.scrollWheelZoom.disable();

    var geoJson = [];
    geoJson.push({
        "type": "Feature",
        "geometry": {
            "type": "Point",
            "coordinates": [<%= @job.well.x_location %>, <%= @job.well.y_location %>]
        },
        "properties": {
            title: '<%= @job.well.field.name + ' | ' + @job.well.name %>',
            'marker-size': 'medium',
            'marker-color': '#0058a8'
            //'marker-symbol': '1'
        }
    });

    map.markerLayer.setGeoJSON(geoJson);

    map.markerLayer.on('click', function (e) {
        ///map.panTo(e.layer.getLatLng());
    });

    var bounds = [];
    bounds.push([<%= @job.well.y_location %>, <%= @job.well.x_location %>]);
    map.fitBounds(bounds);
    map.setZoom(6);
    //zoom = Math.round(map.getZoom());
    //if (zoom > 8) {
    //    map.setZoom(8);
    //}


    map.markerLayer.on('mouseover', function (e) {
        //e.layer.openPopup();
    });
    map.markerLayer.on('mouseout', function (e) {
        //e.layer.closePopup();
    });

    $('.expand-map-box').live("click", function () {
        if ($('.expand-text').text() == 'expand') {
            $('.expand-text').text('collapse');
            $('.map-container').css('height', '500px');
            $('.map-views').removeClass('hidden');
        }
        else {
            $('.expand-text').text('expand');
            $('.map-container').css('height', '80px');
            $('.map-views').addClass('hidden');
        }
        map._onResize();
        return false;
    });

    $('.map-area-view').live("click", function () {
        layer = L.mapbox.tileLayer('elephant.map-vum3on5g');
        layer.addTo(map);
        map.setZoom(6);
        map._onResize();
        return false;
    });

    $('.map-site-view').live("click", function () {
        layer = L.mapbox.tileLayer('elephant.map-6f5p6pfx');
        layer.addTo(map);
        map.setZoom(13);
        map.fitBounds(bounds);
        map._onResize();
        return false;
    });
</script>


<br><br><br>
<br><br><br>



